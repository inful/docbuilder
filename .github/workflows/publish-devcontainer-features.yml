name: Publish DevContainer Features

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
    paths:
      - 'features/**'
      - '.versions'
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  publish-features:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Sync feature versions
        run: |
          chmod +x scripts/sync-feature-versions.sh
          ./scripts/sync-feature-versions.sh

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Docker authentication
        run: |
          echo "Checking Docker authentication..."
          docker login ghcr.io -u ${{ github.actor }} --password-stdin <<< "${{ secrets.GITHUB_TOKEN }}"
          echo "Authenticated as: ${{ github.actor }}"

      - name: Determine version tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Use release tag (e.g., v1.0.0)
            VERSION="${{ github.event.release.tag_name }}"
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/tags/v* ]]; then
            # Tag push (e.g., v1.0.0)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          else
            # Use commit SHA for non-release builds
            VERSION="sha-$(git rev-parse --short=7 HEAD)"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Publish features
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Publishing features with version: ${VERSION}"
          echo "Registry: ghcr.io"
          echo "Namespace: inful"
          echo "Authenticated user: ${{ github.actor }}"
          echo ""
          
          # Ensure Docker credentials are available
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Publish each feature
          for feature_dir in features/*/; do
            if [ -f "${feature_dir}devcontainer-feature.json" ]; then
              feature_name=$(basename "$feature_dir")
              echo "========================================="
              echo "Publishing feature: ${feature_name}"
              echo "Directory: ${feature_dir}"
              echo "Target: ghcr.io/inful/devcontainer-features/${feature_name}:${VERSION}"
              echo "========================================="
              
              # Check what files exist
              echo "Feature files:"
              ls -la "${feature_dir}"
              echo ""
              
              # Show what we're about to publish
              echo "Feature metadata:"
              cat "${feature_dir}devcontainer-feature.json"
              echo ""
              
              # Run with verbose output and capture full output
              set -x
              output=$(devcontainer features publish \
                "${feature_dir}" \
                -r ghcr.io \
                -n inful 2>&1) || {
                  # Check if it failed but the feature was still published
                  if echo "$output" | grep -q "Published feature:"; then
                    echo "⚠️  Warning: Publish command returned error but feature was published"
                    echo "This is likely due to collection metadata failure (can be ignored)"
                  else
                    echo "ERROR: Failed to publish ${feature_name}"
                    echo "Output: $output"
                    exit 1
                  fi
                }
              set +x
              
              echo "Publish output:"
              echo "$output"
              
              # Now tag with our version
              echo ""
              echo "Tagging as version ${VERSION}..."
              oci_ref="ghcr.io/inful/${feature_name}"
              
              # The publish creates tags based on version in devcontainer-feature.json
              # We need to also tag it with our release version
              if docker manifest inspect "${oci_ref}:latest" > /dev/null 2>&1; then
                echo "✓ Found published package at ${oci_ref}:latest"
                echo "Creating additional version tag ${VERSION}..."
                
                # Create version tag
                docker buildx imagetools create \
                  "${oci_ref}:latest" \
                  --tag "${oci_ref}:${VERSION}" || {
                    echo "⚠️  Could not create version tag, but package was published with semver tags"
                  }
                
                echo ""
                echo "✓ Package available at:"
                echo "  - ${oci_ref}:latest"
                echo "  - ${oci_ref}:1"
                echo "  - ${oci_ref}:1.0"  
                echo "  - ${oci_ref}:1.0.0"
                echo "  - ${oci_ref}:${VERSION} (if tagging succeeded)"
              else
                echo "⚠️  Package not found at ${oci_ref}:latest"
              fi
              
              # Check if output contains any useful information
              if echo "$output" | grep -qi "error\|fail\|denied"; then
                echo "⚠️  Warning: Output contains error indicators"
              fi
              if echo "$output" | grep -qi "success\|pushed\|published"; then
                echo "✓ Output contains success indicators"
              fi
              
              echo ""
              echo "✓ Published: ghcr.io/inful/devcontainer-features/${feature_name}:${VERSION}"
              echo ""
              
              # Verify the package was created - try multiple possible locations
              echo "Verifying package..."
              sleep 2  # Give registry time to register the package
              
              found=false
              for pkg_path in \
                "ghcr.io/inful/devcontainer-features/${feature_name}:${VERSION}" \
                "ghcr.io/inful/features/${feature_name}:${VERSION}" \
                "ghcr.io/inful/${feature_name}:${VERSION}"; do
                
                echo "Checking: ${pkg_path}"
                if docker manifest inspect "${pkg_path}" > /dev/null 2>&1; then
                  echo "✓ Found package at: ${pkg_path}"
                  found=true
                  break
                fi
              done
              
              if [ "$found" = false ]; then
                echo "⚠️  Warning: Could not verify package in any expected location"
                echo "Attempting to list packages via API..."
                curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                  "https://api.github.com/users/inful/packages?package_type=container" | \
                  jq -r 'if type == "array" then .[].name else "Error: \(.message // "Unknown error")" end' | \
                  grep -i "devcontainer\|docbuilder" || echo "No matching packages found"
              fi
              echo ""
            fi
          done
          
          echo ""
          echo "========================================="
          echo "All features published successfully!"
          echo "========================================="

      - name: Update latest tag (release only)
        if: github.event_name == 'release'
        run: |
          echo "Tagging as 'latest' for release"
          # The devcontainer CLI automatically tags as latest for releases
          # This step is informational only

      - name: Generate feature documentation
        if: github.event_name == 'release'
        run: |
          echo "## Published Features" > feature-release.md
          echo "" >> feature-release.md
          echo "Version: ${{ steps.version.outputs.version }}" >> feature-release.md
          echo "" >> feature-release.md
          echo "### Usage" >> feature-release.md
          echo '```json' >> feature-release.md
          echo '{' >> feature-release.md
          echo '  "features": {' >> feature-release.md
          
          for feature_dir in features/*/; do
            if [ -f "${feature_dir}devcontainer-feature.json" ]; then
              feature_name=$(basename "$feature_dir")
              echo "    \"ghcr.io/inful/devcontainer-features/${feature_name}:${{ steps.version.outputs.version }}\": {}" >> feature-release.md
            fi
          done
          
          echo '  }' >> feature-release.md
          echo '}' >> feature-release.md
          echo '```' >> feature-release.md

      - name: Upload documentation artifact
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: feature-documentation
          path: feature-release.md
